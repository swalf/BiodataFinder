#!/usr/bin/env ruby
#
# This is a command line interface for BiodataFinder
#
# Author::    Alessandro Bonfanti  (mailto:swalf@users.noreply.github.com)
# Copyright:: Copyright (c) 2014, Alessandro Bonfanti
# License::   GNU GPLv3
$Version = "0.1.18.pre"

require 'thor'
require_relative '../lib/bdf-indexer.rb'
require_relative '../lib/bdf-finder.rb'
require 'elasticsearch'

$conf_file = ENV['HOME'] + "/.biodatafinder/bdf.conf"

class BDFcli < Thor
    @def_index
    
    private
    
    def load_setup
		unless File.exist? $conf_file
			Dir.mkdir (File.dirname $conf_file) 
			File.open($conf_file, "w") do |f|
				f.puts(
					"# bdf-cli config file:",
					"# sintax KEY:=\"VALUE\"",
					"def_index:=\"idx\"",
					"indexes:=\"idx\"",
					"host:=\"http://localhost:9220\""
				)
			end
		end
		File.open($conf_file,"r") do |file|
			file.each do |line|
				next if line[0] == '#'
				key, value = line.split(/:="/)
				value = (value.chomp).chomp "\""
				case key
				when "def_index"
					@def_index = value.downcase
				when "indexes"
					@indexes = value.split(',')
				when "host"
					@host = value
				else 
					raise "Config file entain wrong fields!"
				end
			end
		end
	rescue RuntimeError => e
		if e.message == "Config file entain wrong fields!"
			$stderr.puts "Error: #{exc.message}", "Config file will be not loaded."
		else
			$stderr.puts "Error: #{exc.message}"
		end
	end
    
	def store_setup   
		File.open($conf_file,"w") do |file|
			file.puts( 
				"# bdf-cli config file:",
				"# sintax 'key':'value'",
				"def_index:=\"#{@def_index}\"",
				"indexes:=\"#{@indexes.join(',')}\"",
				"host:=\"#{@host}\""
			)		
		end
	rescue RuntimeError => e
		$stderr.puts "ERROR: " + e.message      
	end
    	
    
    public
        
    desc "index FILEPATH", "Index a specificated file"
    method_option :index, :aliases => "-i", :desc => "Specify the index where the input file will be indexed, elsewere were used default"
    method_option :filetype, :aliases => "-t", :desc => "Specify the filetype, elsewere indexer will try to deduce filetype from extension"
    def index (filepath)
        load_setup
		
        if options[:index] != nil
            index = options[:index]
        else
            if @def_index != nil
                index = @def_index
            else
                raise "If you don't specify an espicit index, you have to set default index key with setdef command."
            end
        end
		
		puts "Indexing on ES #{@host}, index '#{index}'"
		
        client = Elasticsearch::Client.new log: false, host: @host
        indexer = Indexer.new client, index
        indexer.parse filepath, options[:filetype]
		
		unless @indexes.include? index
			@indexes << index
			store_setup
		end
		
		puts "Ok, '#{filepath}' processed" 
    rescue Faraday::ConnectionFailed => e
        puts "It seems that there is no running istance of ElasticSearch running on '#{@host}', plese start it before use bdf-cli."
	rescue Elasticsearch::Transport::Transport::Errors => e
		puts "Something in ElasticSearch has failed, parsing process aborted"
		puts e.message
    rescue RuntimeError => e
        $stderr.puts "ERROR: " + e.message
    end
    
    desc "set --FIELD_NAME=VALUE", "Set the config fields"
    method_option :def_index, :aliases => "-i", :desc => "Set the default index name."
	method_option :host, :aliases => "-h", :desc => "Set the default ES host."
	method_option :indexes, :aliases => "-x", :desc => "Set the indexes that bdf have to manage."
    def setdef
        load_setup
        options.each_pair do |field,value|  
            case field
            when "def_index"
            	raise "'#{value}' is not a valid index!" unless @indexes.include? value
                @def_index = value
                store_setup 
                puts "Default index = #{@def_index}"
            when "indexes"
            	@indexes = value.split(',') #security check needed
            	store_setup    
            	puts "Indexes = #{@indexes}"
			when "host"
				#security control lacks
				@host = value
				store_setup
				puts "Host = #{@host}"
            else
                raise "Wrong field!"
            end
        end
		puts @host
		puts @def_index
		puts @indexes 
    rescue RuntimeError => e
        $stderr.puts "ERROR: " + e.message    
    end
    
    desc "search TEXT TO SEARCH", "Search a string of text in an index"
    method_option :index, :aliases => "-i", :desc => "Specifify in which index search will be implemented, '*' for all indexes, elsewere default will be used."
    method_option :output_format, :aliases => "-f", :desc => "Specify the format of output, allovable values are 'json', 'rawline', 'pretty_output'."
    def search (*text)
        load_setup
        client = Elasticsearch::Client.new log: false, host: @host
        index = options[:index]
        index = @def_index if index.nil?
        raise "If you don't specify an espicit index, you have to set default index key with setdef command." if index.nil?
        finder = Finder.new(client, index)
        query_text = text.join(' ')
        of = options[:output_format]
        of = 'pretty_json' if of.nil?
		raise "Wrong output format!" unless ["json","pretty_json","object"].include? of
		
		puts "Searching on ES #{@host}, index '#{index}'"
		
        results = finder.query query_text
        puts "#{results[:gen_infos][:nres]} result(s) found (max score #{results[:gen_infos][:max_scores]}):"
        results[:objs].each_with_index do |obj,i|
            puts(
				"=======",
				"Result #{i+1}",
				"score: #{obj[:infos][:scores]}",
				"type: #{obj[:infos][:filetype]}",
				"file: #{obj[:infos][:filepath]}",
				"-------"
			)
			case of
			when 'pretty_json'
				puts (JSON.pretty_generate obj[:data])
			when 'json'
				puts (JSON.generate obj[:data])
			when 'object'
				puts obj[:data].to_s
			end
        end
	#Missing index ES exeption have to be catched	
    rescue Faraday::ConnectionFailed
		puts "It seems that there is no running istance of ElasticSearch running on '#{@host}', plese start it before use bdf-cli."
	rescue Elasticsearch::Transport::Transport::Errors => e
		puts "Something in ElasticSearch has failed, searching process aborted"
		puts e.message
	rescue RuntimeError => e
		$stderr.puts "ERROR: " + e.message    
	end
    
	
	desc "ilist","List indexes"
	method_option :output_format, :aliases => "-f", :desc => "Specify the format of output, allovable values are 'json', 'rawline', 'pretty_output'."
	def ilist
		load_setup
		of = options[:output_format] || 'pretty_json'
		case of
		when 'pretty_json'
			puts JSON.pretty_generate(@indexes)
		when 'json'
			puts JSON.generate(@indexes)
		when 'list'
			puts @indexes
		else
			raise "Invalid output format"
		end
	rescue RuntimeError => e
		$stderr.puts "ERROR: " + e.message    
	end
	
	
	desc "delete", "Delete indexes or files"
	method_option :index, :aliases => "-i", :desc => "Delete index with name OPTION_ARG"
	method_option :file, :aliases => "-f", :desc => "Delete all documents of file with name OPTION_ARG"
	def delete
		load_setup
		client = Elasticsearch::Client.new log: false, host: @host
		if !options[:index].nil?
			raise "'#{options[:index]}' is not a valid index!" unless @indexes.include? options[:index]
			client.indices.delete index: options[:index]
			puts "Delete process on ES #{@host}, index '#{options[:index]}'"
			@indexes.delete options[:index]
			puts "OK, '#{options[:index]}' deleted"
		elsif option[:file].any?
			puts "Sorry, not yet implemented."
		end
	rescue Faraday::ConnectionFailed
		puts "It seems that there is no running istance of ElasticSearch running on '#{@host}', plese start it before use bdf-cli."
	rescue RuntimeError => e
		$stderr.puts "ERROR: " + e.message  
	ensure
		store_setup
	end
	
	desc "puts_infos", "Show program infos"
	method_option :version, :aliases => "-v", :desc => "Show version number"
	def puts_infos
		if options[:version] != nil
			puts "BiodataFinder #{$Version}."
		else 
			puts(
				"This is bdf-cli, a command line interface for BiodataFinder",
				"BiodataFinder,  Copyright (C) 2014  Alessandro Bonfanti",
				"This program comes with ABSOLUTELY NO WARRANTY;",
				"This is free software, and you are welcome to redistribute it under certain conditions.",
				"See http://www.gnu.org/licenses/gpl.html GNU_GPLv3 licence for details."			
			)
		end
	end
		
	default_task :puts_infos
		
    
end

BDFcli.start ARGV
